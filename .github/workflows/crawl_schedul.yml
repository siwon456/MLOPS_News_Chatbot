name: Scheduled News Crawler

on:
  schedule:
    - cron: '0 0 * * *' # 매일 자정 실행
  workflow_dispatch: # 수동 실행 허용

concurrency: # 동시에 하나의 워크플로우만 실행되도록 설정
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # 최신 checkout 액션 사용

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9' # 또는 사용하는 파이썬 버전 (3.8 이상 권장)

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas beautifulsoup4 requests chromadb sentence-transformers langchain-community cohere ollama numpy

    - name: Run data pipeline
      run: python data_pipeline.py

    - name: Commit and Push new data
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        echo "--- DEBUG: Commit and Push Start ---"
        echo "Current directory: $(pwd)"
        echo "Listing all files in current directory:"
        ls -la
        echo "Listing contents of 'data/' directory:"
        ls -la data/ || true # data 폴더가 없어도 에러내지 않음
        echo "Listing 'chroma_db_DB*' folders (if exist):"
        ls -la chroma_db_DB* || true
        
        # ChromaDB 폴더를 강제로 추가 ('.gitignore'에 있어도 추가 시도)
        git add -f chroma_db_DB* || true 
        # CSV 파일도 추가
        git add data/*.csv || true
        git add .
        
        # 변경 사항이 있는지 확인 (없으면 커밋 스킵)
        if git diff-index --quiet HEAD; then
          echo "No changes detected. Skipping commit and push."
        else
          echo "Changes detected. Proceeding with commit and push."
          git commit -m "Automated data update: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "Attempting to push changes to remote repository."
          git pull # 충돌 방지를 위해 먼저 pull 시도 (간단한 pull)
          git push
          echo "--- DEBUG: Commit and Push End ---"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 기본 GITHUB_TOKEN 사용
