name: Scheduled News Crawler

on:
  schedule:
    - cron: '0 */2 * * *' # 2시간마다 실행
  workflow_dispatch: # 수동 실행 허용

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 기존 라이브러리들
        pip install pandas beautifulsoup4 requests chromadb sentence-transformers langchain-community langchain tqdm
        # 추가: langchain.text_splitter 모듈을 위한 패키지 설치
        pip install langchain-text-splitters
        # ChromaDB telemetry 오류를 방지하기 위해 cohere 제거 (만약 cohere가 설치되어 있다면)
        pip uninstall -y cohere || true

    - name: Ensure data directory exists
      run: mkdir -p data

    - name: Run data pipeline
      run: python pipeline.py
      env:
        NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
        NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

    - name: Commit and Push new data
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        echo "--- DEBUG: Commit and Push Start ---"
        
        # 모든 DB 폴더와 CSV 파일 추가
        git add -f chroma_db_DB* || true 
        git add data/*.csv || true # data/*.csv 추가 (pipeline.py가 생성할 수 있음)
        
        if git diff-index --quiet HEAD; then
          echo "No changes detected. Skipping commit and push."
        else
          echo "Changes detected. Proceeding with commit and push."
          git commit -m "Automated data update (Every 2 Hours, Individual DBs): $(date +'%Y-%m-%d %H:%M:%S')"
          git pull --rebase
          git push
          echo "--- DEBUG: Commit and Push End ---"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
